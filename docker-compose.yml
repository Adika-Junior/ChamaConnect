services:
  # runtime app (php-fpm) uses code baked into the image and named volumes for writable dirs
  app:
    build: .
    image: ttms_app:latest
    container_name: ttms_app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - app_storage:/var/www/html/storage
      - app_cache:/var/www/html/bootstrap/cache
    networks:
      - ttms-network
    depends_on:
      - db
    env_file:
      - .env.docker
    healthcheck:
      test: ["CMD-SHELL", "php -r 'echo \'ok\';' >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    # entrypoint in image will ensure permissions on startup

  nginx:
    image: nginx:stable
    container_name: ttms_nginx
    restart: unless-stopped
    ports:
      - 8000:80
    volumes:
      # nginx will mount the code copied into the app_code volume (populated by init_app service)
      - app_code:/var/www/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - ttms-network
    depends_on:
      - app

  db:
    image: mysql:8.0
    container_name: ttms_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: team_task_management
      MYSQL_USER: ttms_user
      MYSQL_PASSWORD: ttms_pass
    ports:
      - 3307:3306
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - ttms-network

  redis:
    image: redis:7.2-alpine
    container_name: ttms_redis
    restart: unless-stopped
    ports:
      - 6380:6379
    networks:
      - ttms-network

  reverb:
    image: ttms_app:latest
    container_name: ttms_reverb
    working_dir: /var/www/html
    command: ["php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=8080"]
    env_file:
      - .env.docker
    ports:
      - 8080:8080
    networks:
      - ttms-network
    depends_on:
      - app
      - redis

  janus:
    image: canyan/janus-gateway:latest
    container_name: ttms_janus
    restart: unless-stopped
    ports:
      - 8088:8088   # HTTP/WebSocket
      - 8188:8188   # Admin HTTP
      - 8009:8009   # RTP/RTCP
      - 20000-20020:20000-20020/udp  # RTP/RTCP UDP range
    volumes:
      - janus_config:/etc/janus
      - janus_recordings:/var/janus
    networks:
      - ttms-network
    environment:
      - JANUS_CONFIG=/etc/janus/janus.jcfg
    depends_on:
      - db
  # developer workspace: uses the same image but does bind-mounting only for development tasks (optional)
  workspace:
    image: ttms_app:latest
    container_name: ttms_workspace
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html:cached
      - app_storage:/var/www/html/storage
      - app_cache:/var/www/html/bootstrap/cache
    networks:
      - ttms-network
    env_file:
      - .env.docker
    entrypoint: ["/bin/sh", "-c", "while true; do sleep 3600; done"]

  # init container to copy built image's code into the app_code volume so nginx can serve files
  init_app:
    image: ttms_app:latest
    container_name: ttms_init_app
    command: ["/bin/sh", "-c", "rm -rf /target/* && cp -a /var/www/html/. /target && chown -R www-data:www-data /target"]
    volumes:
      - app_code:/target
    networks:
      - ttms-network

volumes:
  db_data:
  app_storage:
  app_cache:
  app_code:
  janus_config:
  janus_recordings:

networks:
  ttms-network:
    driver: bridge
